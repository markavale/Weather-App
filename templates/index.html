{% extends 'base.html' %} {% load static %} {% block content %}
<div class="container p-5" id="App">
  <form @submit.prevent="addCity">
    <div class="form-group">
      <div class="main-search-input-wrap mb-5">
        <div class="main-search-input fl-wrap">
          <div class="main-search-input-item">
            <input
              type="text"
              value=""
              v-model="name"
              placeholder="Add any city..."
            />
          </div>
          <button class="main-search-button">ADD</button>
        </div>
      </div>
    </div>
  </form>
  <div class="weather-container mt-5 justify-content-center">
    <div class="weather">
      <div class="row">
        <div class="col-md-6" v-for="(data, index) in weathers">
          <div class="card">
            <span class="icon"><img class="img-fluid" :src="data.icon" /></span>
            <div class="title">
              <p>{data.city_name}</p>
            </div>
            <div class="temp">{data.temperature}F<!-- <sup>&deg;</sup> -->
            </div>
            <div class="row">
              <div class="col-12">
                <div class="value">{data.description}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- <script src="{% static 'js/vue.js' %}"></script> -->
<script src="{% static 'js/vue.min.js' %}"></script> 
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type="module">
  var host_name_production = "https://projectweatherapi.herokuapp.com";
  var host_name_development = "http://localhost:8000";
  //var api_key = "13417a3f4de1d1d1f86ccf8e6fd1277f";
  var api_key = "f882fb1658025ca36144d0e9a23a5197";
  
  var app = new Vue({
    el: "#App",
    delimiters: ["{", "}"],
    data: {
      name: "",
      cities: [],
      weather_city_list: [],
      weathers: [],
    },
    mounted() {
      this.getCity();
      this.getWeatherAPI();
      this.fetchServer();
      console.log("Component mounted");
    },
    beforeMount() {
      console.log("Before mounted");
    },
    computed: {
      // a computed getter
      toCelsius() {
        // `this` points to the vm instance
        const fahrenheit = this.weathers.temperature;
        const celsius = (298.1 - 32) / 1.8;
        console.log(celsius.toFixed(2));
        return celsius.toFixed(2);
      },
    },
    methods: {
      getWeatherAPI() {
        axios
          .get(`${host_name_production}/api/city/weather/`)
          .then((res) => {
            this.weathers = res.data;
            console.log("Get request from server success!!");
            console.log(this.weathers);
          })
          .catch((err) => console.log(err));
      },
      getCity() {
        axios
          .get(`${host_name_production}/api/city/`)
          .then((res) => {
            this.cities = res.data;
            let city_list = this.cities;
            console.log(city_list);
            console.log(res.data);
            console.log(city_list.length);
            console.log(this.weather_city_list);
          })
          .catch((err) => console.log(err));
      },
      sendServer() {
        console.log("sendServer inital");
        console.log(this.weather_city_list);
        axios({
          method: "post",
          url: `${host_name_production}/api/city/weather/`,
          data: {
            city_name: this.weather_city_list.city,
            temperature: this.weather_city_list.temperature,
            description: this.weather_city_list.description,
            icon: this.weather_city_list.icon,
          },
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "content-type": "application/json",
          },
        })
          .then((res) => {
            this.getWeatherAPI();
            console.log("sendServer works");
          })
          .catch((err) => console.log(err));
      },
      addCity() {
        const data = {
          name: this.name,
        };
        axios({
          method: "post",
          url: `${host_name_production}/api/city/`,
          data: {
            name: this.name,
          },
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "content-type": "application/json",
          },
        })
          .then((res) => {
            console.log(res.data);
            //this.name = "";
            this.fetchServer();
            this.getCity();
            console.log("addCity works");
          })
          .catch((err) => console.log(err));
      },
      fetchServer() {
        axios
          .get(
            `http://api.openweathermap.org/data/2.5/weather?q=${this.name}&APPID=${api_key}`
          )
          .then((res) => {
            this.weather_city_list.push({
              city: res.data.name,
              temperature: res.data.main.temp,
              description: res.data.weather[0].description,
              icon:
                "http://openweathermap.org/img/w/" +
                res.data.weather[0].icon +
                ".png",
            });
            this.name = "";
            console.log("fetchServer works");
            console.log("executing post request to server.");
            console.log(this.weather_city_list);
            console.log(this.weather_city_list[0].city);
            console.log(this.weather_city_list[0].temperature);
            console.log(this.weather_city_list[0].description);
            console.log(this.weather_city_list[0].icon);
            axios({
              method: "post",
              url: `${host_name_production}/api/city/weather/`,
              data: {
                city_name: this.weather_city_list[0].city,
                temperature: this.weather_city_list[0].temperature,
                description: this.weather_city_list[0].description,
                icon: this.weather_city_list[0].icon,
              },
              headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "content-type": "application/json",
              },
            })
              .then((res) => {
                this.getWeatherAPI();
                console.log("sendServer works");
              })
              .catch((err) => console.log(err));
          })
          .catch((err) => console.log(err)); // 1st get
      },
    },
  });
</script>
{% endblock content %}
