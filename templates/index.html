{% extends 'base.html' %} {% load static %} {% block content %}
<div class="" id="App">
  <div class="container">
    <form @submit.prevent="addCity">
      <div class="form-group">
        <div v-if="city_not_exist" class="alert alert-danger alert-dismissible fade show mt-4 " role="alert">
          Oooppss! Looks like <strong>{name}</strong> does not exist in the world ðŸ˜¢.
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="main-search-input-wrap mb-5">
          <div class="main-search-input fl-wrap">
            <div class="main-search-input-item">
              <input
                type="text"
                value=""
                v-model="name"
                placeholder="Add any city..."
                name="name"
              />
            </div>
            <button
              v-if="!loading"
              :disabled="name.length== 0"
              class="main-search-button"
            >
              ADD
            </button>
            <button v-else class="main-search-button">
              <i
                class="fa fa-circle-o-notch fa-spin"
                style="font-size: 24px; color: white"
              ></i>
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="weather-container mt-5 justify-content-center">
    <div class="weather">
      <div class="row">
        <div class="col-md-6" v-for="(data, index) in weathers">
          <div class="card">
            <span class="icon"><img class="img-fluid" :src="data.icon" /></span>
            <div class="title">
              <p>{data.city_name}</p>
            </div>
            <div class="temp">{data.temperature}F<!-- <sup>&deg;</sup> --></div>
            <div class="row">
              <div class="col-12">
                <div class="value">{data.description}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- <script src="{% static 'js/vue.js' %}"></script> -->
<script src="{% static 'js/vue.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type="module">
  var host_name_production = "projectweatherapi.herokuapp.com";
  var host_name_development = "http://localhost:8000";
  var host_name = host_name_production;
  //var api_key = "13417a3f4de1d1d1f86ccf8e6fd1277f";
  var api_key = "f882fb1658025ca36144d0e9a23a5197";

  var app = new Vue({
    el: "#App",
    delimiters: ["{", "}"],
    data: {
      name: "",
      cities: [],
      weather_city_list: [],
      weather_obj: {
        city_name: null,
        description: null,
        temperature: null,
        icon: null,
      },
      city_not_exist: false,
      empty: false,
      loading: false,
      weathers: [],
    },
    mounted() {
      this.getCity();
      this.getWeatherAPI();
      console.log("Component mounted");
    },
    beforeMount() {
      console.log("Before mounted");
    },
    computed: {
      // a computed getter
      toCelsius() {
        // `this` points to the vm instance
        const fahrenheit = this.weathers.temperature;
        const celsius = (298.1 - 32) / 1.8;
        console.log(celsius.toFixed(2));
        return celsius.toFixed(2);
      },
    },
    methods: {
      getWeatherAPI() {
        axios
          .get(`/api/city/weather/`)
          .then((res) => {
            this.weathers = res.data;
            console.log("Get request from server success!!");
            console.log(this.weathers);
          })
          .catch((err) => console.log(err));
      },
      getCity() {
        axios
          .get(`/api/city/`)
          .then((res) => {
            this.cities = res.data;
            let city_list = this.cities;
            console.log(city_list);
            console.log(res.data);
            console.log(city_list.length);
            console.log(this.weather_city_list);
          })
          .catch((err) => console.log(err));
      },
      sendServer() {
        console.log("sendServer inital");
        console.log(this.weather_city_list);
        axios({
          method: "post",
          url: `/api/city/weather/`,
          data: {
            city_name: this.weather_city_list.city,
            temperature: this.weather_city_list.temperature,
            description: this.weather_city_list.description,
            icon: this.weather_city_list.icon,
          },
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "content-type": "application/json",
          },
        })
          .then((res) => {
            this.getWeatherAPI();
            console.log("sendServer works");
          })
          .catch((err) => console.log(err));
      },
      addCity() {
        console.log("Start");
        const data = {
          name: this.name,
        };
        this.loading = true;
        axios({
          method: "post",
          url: `/api/city/`,
          data: {
            name: this.name,
          },
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "content-type": "application/json",
          },
        })
          .then((res) => {
            console.log("executing add city");
            console.log(this.name);
            //this.name = "";
            this.fetchServer();
            this.getCity();
            this.loading = false;
            console.log("addCity works");
          })
          .catch((err) => console.log(err));
      },
      fetchServer() {
        axios
          .get(
            `https://api.openweathermap.org/data/2.5/weather?q=${this.name}&APPID=${api_key}`
          )
          .then((res) => {
            this.weather_obj.city_name = res.data.name;
            this.weather_obj.temperature = res.data.main.temp;
            this.weather_obj.description = res.data.weather[0].description;
            this.weather_obj.icon =
              "https://api.openweathermap.org/img/w/" +
              res.data.weather[0].icon +
              ".png";

            this.weather_city_list.push({
              city: res.data.name,
              temperature: res.data.main.temp,
              description: res.data.weather[0].description,
              icon:
                "https://api.openweathermap.org/img/w/" +
                res.data.weather[0].icon +
                ".png",
            });
            console.log(res.data);
            console.log(res.data.cod);
            this.name = "";
            console.log("fetchServer works");
            console.log(this.weather_city_list);
            console.log(this.weather_city_list[0].city);
            console.log(this.weather_city_list[0].temperature);
            console.log(this.weather_city_list[0].description);
            console.log(this.weather_city_list[0].icon);
            console.log("executing post request to server.");
            axios({
              method: "post",
              url: `/api/city/weather/`,
              data: {
                city_name: this.weather_obj.city_name,
                temperature: this.weather_obj.temperature,
                description: this.weather_obj.description,
                icon: this.weather_obj.icon,
              },

              headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "content-type": "application/json",
              },
            })
              .then((res) => {
                this.getWeatherAPI();
                console.log("sendServer works");
                console.log("END");
              })
              .catch((err) => console.log(err));
          })
          .catch((err) => {
            console.log(err);
            this.city_not_exist = true;
            console.log(this.city_not_exist);
          }); // 1st get
      },
    },
  });
</script>
{% endblock content %}
